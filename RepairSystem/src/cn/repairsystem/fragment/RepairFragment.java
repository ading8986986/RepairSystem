package cn.repairsystem.fragment;import java.util.ArrayList;import java.util.List;import java.util.Map;import org.json.JSONArray;import org.json.JSONException;import org.json.JSONObject;import cn.repairsystem.R;import cn.repairsystem.RepairSystemApplication;import cn.repairsystem.activity.ListItemActivity;import cn.repairsystem.activity.QueDecActivity;import cn.repairsystem.bean.CurrentRepairItem;import cn.repairsystem.bean.RepairBuilding;import cn.repairsystem.bean.RepairProjectItem;import cn.repairsystem.bean.RepairSubProject;import cn.repairsystem.bean.RepairZoneItem;import cn.repairsystem.network.HttpController;import cn.repairsystem.network.HttpController.HttpResultListener;import cn.repairsystem.util.UtilToast;import android.app.Application;import android.app.ListActivity;import android.content.Intent;import android.os.Bundle;import android.support.annotation.Nullable;import android.support.v4.app.Fragment;import android.view.LayoutInflater;import android.view.View;import android.view.View.OnClickListener;import android.view.ViewGroup;import android.widget.Button;import android.widget.LinearLayout;import android.widget.ListView;import android.widget.TextView;public class RepairFragment extends Fragment implements OnClickListener ,HttpResultListener{		private View mView;	private TextView repaireZoneTextView;	private TextView repaireBuildingTextView;	private TextView repaireProjectTextView;	private TextView repaireSubProjectTextView;	private TextView repaireDecTitleTextView;	private Button submitButton;	private LinearLayout waitingLayout;		private HttpController mController;			private Map<Integer, ArrayList<RepairBuilding>> zoneBuildingMap;	private Map<Integer, ArrayList<RepairSubProject>> repairSubProjectMap;	private SubmitObject submitObject;	private int curSelectedItem;//当前选择的是哪一项	private int pageindex;	public static final int repaireZone_List = 101;	public static final int repaireBuilding_List = 102;	public static final int repaireProject_List = 103;	public static final int repaireSubProject_List = 104;	public static final int repaireDecTitle_List = 105;	public final int repairSubmit = 106;	private SubmitListener mListener;		public static interface SubmitListener{		public void onSubmit();	}		private class SubmitObject{		public int repaireZone = -1;		public int repaireBuilding = -1;		public int repaireProject = -1;		public int repaireSubProject = -1;		public String repaireDecTitle = "";		public String repaireDecContent = "";		public String tel = "";	}					@Override	public View onCreateView(LayoutInflater inflater,			@Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {		// TODO Auto-generated method stub		mView = View.inflate(getActivity(), R.layout.repair_fragment, null);		initView();		initData();		return mView;	}		private void initView(){		repaireZoneTextView = (TextView) mView.findViewById(R.id.zone_tv);		repaireBuildingTextView = (TextView) mView.findViewById(R.id.building_tv);		repaireProjectTextView = (TextView) mView.findViewById(R.id.project_category_tv);		repaireSubProjectTextView = (TextView) mView.findViewById(R.id.project_subcategory_tv);		repaireDecTitleTextView = (TextView) mView.findViewById(R.id.question_des_tv);		submitButton = (Button) mView.findViewById(R.id.submit);		waitingLayout = (LinearLayout) mView.findViewById(R.id.ll_waiting_layout);		submitButton.setOnClickListener(this);		mView.findViewById(R.id.zone_rl).setOnClickListener(this);		mView.findViewById(R.id.project_category_rl).setOnClickListener(this);		mView.findViewById(R.id.building_rl).setOnClickListener(this);		mView.findViewById(R.id.project_subcategory_rl).setOnClickListener(this);		mView.findViewById(R.id.question_des_rl).setOnClickListener(this);			}		private void initData(){		submitObject = new SubmitObject();		mController = HttpController.getInstance(getActivity());		pageindex = 1;		curSelectedItem = repaireZone_List;//先获取了区域等信息		mController.getRepairInfo(this);	}		public void setmListener(SubmitListener mListener) {		this.mListener = mListener;	}	@Override	public void onClick(View v) {		// TODO Auto-generated method stub		Intent intent = new Intent(getActivity(),ListItemActivity.class);		switch (v.getId()) {				case R.id.question_des_rl:			curSelectedItem = repaireDecTitle_List;			Intent intent_des = new Intent(getActivity(),QueDecActivity.class);			intent_des.putExtra("que_title", submitObject.repaireDecTitle);			intent_des.putExtra("que_content", submitObject.repaireDecContent);			startActivityForResult(intent_des, repaireDecTitle_List);			break;		case R.id.zone_rl:			curSelectedItem = repaireZone_List;			intent.putExtra("data", repaireZone_List);			intent.putExtra("setSelectedItemPos", submitObject.repaireZone);			startActivityForResult(intent, repaireZone_List);			break;		case R.id.project_category_rl:			curSelectedItem = repaireProject_List;			intent.putExtra("data", repaireProject_List);			intent.putExtra("setSelectedItemPos", submitObject.repaireProject);			startActivityForResult(intent, repaireProject_List);			break;		case R.id.project_subcategory_rl:			curSelectedItem = repaireSubProject_List;			if( -1 == submitObject.repaireProject){				UtilToast.showShort(getActivity(), "请选择维修项目");				return;			}			if (RepairSystemApplication.dataCenter.getRepairSubProjectById(submitObject.repaireProject) == null) {				JSONObject param = new JSONObject();				try {					param.put("wxxmid", submitObject.repaireProject);				} catch (JSONException e) {					// TODO Auto-generated catch block					e.printStackTrace();				}				mController.getRepairSubProject(this, param);			}			else{				intent.putExtra("data", repaireSubProject_List);				intent.putExtra("project_id", submitObject.repaireProject);				intent.putExtra("setSelectedItemPos", submitObject.repaireSubProject);				startActivityForResult(intent, repaireSubProject_List);			}			break;		case R.id.building_rl:			curSelectedItem = repaireBuilding_List;			if( -1 == submitObject.repaireZone){				UtilToast.showShort(getActivity(), "请选择维修区域");				return;			}			if (RepairSystemApplication.dataCenter.getZoneBuildingById(submitObject.repaireZone) == null) {				JSONObject param = new JSONObject();				try {					param.put("wxqyid", submitObject.repaireZone);				} catch (JSONException e) {					// TODO Auto-generated catch block					e.printStackTrace();				}				mController.getRepairBuilding(this, param);			}			else{				intent.putExtra("data", repaireBuilding_List);				intent.putExtra("zone_id", submitObject.repaireZone);				intent.putExtra("setSelectedItemPos", submitObject.repaireBuilding);				startActivityForResult(intent, repaireBuilding_List);			}			break;			case R.id.submit:			curSelectedItem = repairSubmit;			if(submitObject.repaireZone == -1){				UtilToast.showShort(getActivity(), "请选择维修区域");				return;			}			if(submitObject.repaireProject == -1){				UtilToast.showShort(getActivity(), "请选择维修项目");				return;			}			waitingLayout.setVisibility(View.VISIBLE);			JSONObject param = new JSONObject();			try {				param.put("wxqyid", submitObject.repaireZone);				param.put("wxxxmid", submitObject.repaireSubProject);				param.put("wxxmid", submitObject.repaireProject);				param.put("buildid", submitObject.repaireBuilding);				param.put("bxtel", "");				param.put("bxtitle", submitObject.repaireDecTitle);				param.put("bxcontent", submitObject.repaireDecContent);				param.put("bxfrom", 2);				param.put("picnamelist","");			} catch (JSONException e) {				// TODO Auto-generated catch block				e.printStackTrace();			}			mController.submit(this, param);			break;		default:			break;		}	}		@Override	public void onResult(boolean isSuccess, JSONObject object) {		// TODO Auto-generated method stub		if(isSuccess && null!=object && curSelectedItem == repaireZone_List){			try {				if(isSuccess && object.get("wxqylist") != null) {//区域信息					RepairSystemApplication.dataCenter.setRepairZoneList(object.getJSONArray("wxqylist"));					RepairSystemApplication.dataCenter.setRepairProjectList(object.getJSONArray("wxxmlist"));				}			}			catch (JSONException e) {				// TODO Auto-generated catch block				e.printStackTrace();			}		}		else if (isSuccess && null!=object && curSelectedItem == repaireBuilding_List) {			ArrayList<RepairBuilding> data = new ArrayList<RepairBuilding>();			JSONArray array;			try {				array = object.getJSONArray("wxqylist");				for (int i = 0; i < array.length(); i++) {					data.add(new RepairBuilding(array.getJSONObject(i)));				}			} catch (JSONException e) {				// TODO Auto-generated catch block				e.printStackTrace();			}						RepairSystemApplication.dataCenter.setZoneBuildingMap(submitObject.repaireZone, data);			Intent intent = new Intent(getActivity(),ListItemActivity.class);			intent.putExtra("data", repaireBuilding_List);			intent.putExtra("zone_id", submitObject.repaireZone);			intent.putExtra("setSelectedItemPos", submitObject.repaireBuilding);			startActivityForResult(intent, repaireBuilding_List);		}				else if (isSuccess && null!=object && curSelectedItem == repaireSubProject_List) {			ArrayList<RepairSubProject> data = new ArrayList<RepairSubProject>();			JSONArray array;			try {				array = object.getJSONArray("wxxxmlist");				for (int i = 0; i < array.length(); i++) {					data.add(new RepairSubProject(array.getJSONObject(i)));				}			} catch (JSONException e) {				// TODO Auto-generated catch block				e.printStackTrace();			}			RepairSystemApplication.dataCenter.setRepairSubProjectMap(submitObject.repaireProject, data);			Intent intent = new Intent(getActivity(),ListItemActivity.class);			intent.putExtra("data", repaireSubProject_List);			intent.putExtra("project_id", submitObject.repaireProject);			intent.putExtra("setSelectedItemPos", submitObject.repaireSubProject);			startActivityForResult(intent, repaireSubProject_List);		}				else if (isSuccess && null!=object && curSelectedItem == repairSubmit){//submit			waitingLayout.setVisibility(View.GONE);			UtilToast.showLong(getActivity(), "提交成功");			if(mListener!=null){				mListener.onSubmit();			}		}			}	@Override	public void onActivityResult(int requestCode, int resultCode, Intent data) {		// TODO Auto-generated method stub		if(requestCode == repaireZone_List && resultCode == repaireZone_List){			repaireZoneTextView.setText(data.getStringExtra("data"));			submitObject.repaireZone = data.getIntExtra("setSelectedItemPos", -1);			submitObject.repaireBuilding = -1;			repaireBuildingTextView.setText("");		}		else if(requestCode == repaireProject_List && resultCode == repaireProject_List){			repaireProjectTextView.setText(data.getStringExtra("data"));			submitObject.repaireProject = data.getIntExtra("setSelectedItemPos", -1);			submitObject.repaireSubProject = -1;			repaireSubProjectTextView.setText("");		}		else if(requestCode == repaireBuilding_List && resultCode == repaireBuilding_List){			repaireBuildingTextView.setText(data.getStringExtra("data"));			submitObject.repaireBuilding = data.getIntExtra("setSelectedItemPos", -1);		}		else if(requestCode == repaireSubProject_List && resultCode == repaireSubProject_List){			repaireSubProjectTextView.setText(data.getStringExtra("data"));			submitObject.repaireSubProject = data.getIntExtra("setSelectedItemPos", -1);		}		else if(requestCode == repaireDecTitle_List && resultCode == repaireDecTitle_List){			repaireDecTitleTextView.setText(data.getStringExtra("que_title"));			submitObject.repaireDecTitle = data.getStringExtra("que_title");			submitObject.repaireDecContent =  data.getStringExtra("que_content");		}	}							}